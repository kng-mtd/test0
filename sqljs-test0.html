<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SQLite on browser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>CSV to SQLite</h1>
    Choose csv file >> <input type="file" id="csvFileInput" accept=".csv">
    <input type="text" id="tableName" placeholder="Enter table name">
    <button id="convertButton">Convert and Download</button>
    <h1>Access SQLite</h1>
    Choose sqlite db file >> <input type="file" id="fileInput">
    <br>
    <textarea id="sqlQuery" rows="4" cols="50">
    select count(*) from -table-;pragma table_info(-table-);</textarea><br>
    <button id="executeButton">Execute query</button>
    <pre id="result"></pre>

    <script>
        let db1;
        async function loadSQL() {
            const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
            db1 = new SQL.Database();
        }

        function convertCSVtoSQLite() {
            const fileInput = document.getElementById('csvFileInput');
            const tableName = document.getElementById('tableName').value.trim();
            const file = fileInput.files[0];

            if (!tableName) {
                alert('Please enter a table name.');
                return;
            }

            Papa.parse(file, {
                header: true,
                complete: function (results) {
                    const data = results.data;
                    const headers = results.meta.fields;

                    createTable(tableName, headers);
                    insertData(tableName, headers, data);
                    downloadDatabase();
                }
            });
        }

        function createTable(tableName, headers) {
            const createTableSQL = `CREATE TABLE ${tableName} (${headers.map(header => `${header} TEXT`).join(", ")});`;
            db1.run(createTableSQL);
        }

        function insertData(tableName, headers, data) {
            const stmt = db1.prepare(`INSERT INTO ${tableName} (${headers.join(", ")}) VALUES (${headers.map(() => '?').join(", ")});`);

            data.forEach(row => {
                const values = headers.map(header => row[header] === undefined ? null : row[header]);
                stmt.run(values);
            });

            stmt.free();
        }

        function downloadDatabase() {
            const binaryArray = db1.export();
            const blob = new Blob([binaryArray], { type: 'application/x-sqlite3' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'database.sqlite';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('convertButton').addEventListener('click', convertCSVtoSQLite);

        loadSQL();

    
        let db2 = null;
        document.getElementById('fileInput').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            // SQL.js database instance
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
            });
            db2 = new SQL.Database(uint8Array);

            document.getElementById('result').textContent = 'Database has already read. you can execute querys';
        });

        document.getElementById('executeButton').addEventListener('click', function() {
            if (db2) {
                const query = document.getElementById('sqlQuery').value;
                try {
                    const results = db2.exec(query);
                    if (results.length > 0) {
                        const resultString = results.map(result => JSON.stringify(result, null, 2)).join('\n');
                        document.getElementById('result').textContent = resultString;
                    } else {
                        document.getElementById('result').textContent = 'No result';
                    }
                } catch (e) {
                    document.getElementById('result').textContent = 'error: ' + e.message;
                }
            } else {
                document.getElementById('result').textContent = 'Database has not read yet';
            }
        });
    </script>
</body>
</html>
